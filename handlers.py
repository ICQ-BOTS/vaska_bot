from tarantool_utils import *
from random import randint, choice
from PIL import Image, ImageDraw, ImageFont
import numexpr as ne
import asyncio
import json
import time
import sys
import os
import re


async def new_start_bot(bot, event):
	await bot.send_text(
			chat_id=event.from_chat,
			text="""–ü—Ä–∏–≤–µ—Ç! üôÉ
–Ø ‚Äî –í–∞—Å—å–∫–∞, —Ç–≤–æ–π —à–∫–æ–ª—å–Ω—ã–π –¥—Ä—É–≥ –∏ –ø–æ–º–æ—â–Ω–∏–∫. –ú–æ–≥—É —Ä–µ—à–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫—É, –¥–µ–ª–∞—Ç—å –∑–∞ —Ç–µ–±—è –ø–∏—Å—å–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å–ø–µ–∫—Ç—ã –∏ –ø—Ä–æ—Å—Ç–æ –±–æ–ª—Ç–∞—Ç—å :) 

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –æ–±–æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö, —Å–ø—Ä–æ—Å–∏ –º–µ–Ω—è: –í–∞—Å—å–∫–∞, —á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?"""
		)	


async def help_mi(bot, event):
	await bot.send_text(
			chat_id=event.from_chat,
			text="""üìí –ü–æ–º–æ–≥–∏ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π ‚Äî –ø—Ä–∏—Å—ã–ª–∞–π –ø—Ä–∏–º–µ—Ä –∏–ª–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ, –∞ —è —Å–∫–∞–∂—É –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 

üìï –ù–∞–ø–∏—à–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç ‚Äî –ø—Ä–∏—Å—ã–ª–∞–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç —Ä—É–∫–∏, –∞ —è –ø—Ä–∏—à–ª—é —Ñ–æ—Ç–æ —Å –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º. 
"""
		)	


async def def_phrases(bot, event):
	user = User(user_id=event.data['from']['userId']).get()
	if user.old_mes['text']:
		# –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç
		await write_text(bot, event)
	else:
		if user.example:
			is_text = re.search(r'[^\W\d]', event.text)
			# –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ –±—É–∫–≤—ã –≤ —Ç–µ–∫—Å—Ç–µ
			event.text = event.text.replace(':', '/')
			if is_text:
				await wolf_ram(bot, event)					
			else:
				try:
					await bot.send_text(
						chat_id=event.from_chat,
						text=round(float(ne.evaluate(event.text)), 5)
					)
					await bot.send_text(
						chat_id=event.from_chat,
						text="–ï—Å—Ç—å –µ—â–µ –Ω–µ —Ä–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã?",
						inline_keyboard_markup="{}".format(json.dumps([
							[{"text": "–î–∞", "callbackData": "call_back_id_1"}],
							[{"text": "–ù–µ—Ç", "callbackData": "call_back_id_5"}]
						]))
					)					
				except Exception as e:
					await wolf_ram(bot, event)		
					
			user.space[1] = False
			user.save()	
		else:
			chat_type = event.data['message']['chat']['type'] if event.data.get('message') else event.data['chat']['type']
			chat_id = event.data['message']['chat']['chatId'] if event.data.get('message') else event.data['chat']['chatId']
			if chat_type == 'private':
				await bot.send_text(
					chat_id=chat_id,
					text=choice(space_phrases.select())[1]
				)


async def sleep_send(bot, event):
	await bot.send_actions(chat_id=event.from_chat, actions='typing')
	await asyncio.sleep(2)


async def wolf_ram(bot, event):
	answer = await bot.send_text(
		chat_id=event.from_chat,
		text="–ù–µ–º–Ω–æ–∂–∫–æ –ø–æ–¥–æ–∂–¥–∏, —Å–µ–π—á–∞—Å –≤—Å–µ –ø–æ—Å—á–∏—Ç–∞—é"
	)
	await sleep_send(bot, event)
	try:
		answers = await wolframalpha_send(bot, client.query(event.text), event)
		if answers:
			await bot.edit_text(
				msg_id=answer['msgId'],
				chat_id=event.from_chat,
				text=answers
			)
			await bot.send_text(
				chat_id=event.from_chat,
				text="–ï—Å—Ç—å –µ—â–µ –Ω–µ —Ä–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã?",
				inline_keyboard_markup="{}".format(json.dumps([
					[{"text": "–î–∞", "callbackData": "call_back_id_1"}],
					[{"text": "–ù–µ—Ç", "callbackData": "call_back_id_5"}]
				]))
			)				
		else:
			await bot.edit_text(
				msg_id=answer['msgId'],
				chat_id=event.from_chat,
				text=f"–ù–µ —Å–º–æ–≥ —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä:\n{event.text}\n–û—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É, —á—Ç–æ–± –Ω–∞—É—á–∏–ª —Å—á–∏—Ç–∞—Ç—å –∏ —Ç–∞–∫–æ–µ —Ç–æ–∂–µ."
			)
	except Exception as e:
		await bot.edit_text(
				msg_id=answer['msgId'],
				chat_id=event.from_chat,
				text=f"–ù–µ —Å–º–æ–≥ —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä:\n{event.text}\n–û—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É, —á—Ç–æ–± –Ω–∞—É—á–∏–ª —Å—á–∏—Ç–∞—Ç—å –∏ —Ç–∞–∫–æ–µ —Ç–æ–∂–µ."
			)
		for admin in ['752284535']:
			await bot.send_text(
				chat_id=admin,
				text="–ù–µ —Å–º–æ–≥ —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä:\n" + event.text
			)			
	

async def wolframalpha_send(bot, res, event, assumption=None):
	if res.success == 'true':
		text = ''
		if assumption is None and 'assumptions' in list(res.keys()):
			res = client.query(event.text, assumption=list(res.assumptions)[0]['assumption']['value'][1]['@input'])
			return await wolframalpha_send(bot, res, event, assumption=True)
		for pod in res.pods:
			if pod.title in ['Decimal approximation', 'Result', 
			'Solutions', 'Solution', 'Exact result', 'Repeating decimal']:
				for sub in pod.subpods:
					sub.plaintext = sub.plaintext[:-3] if sub.plaintext[-3:] == '...' else sub.plaintext
					text += str(round(float(sub.plaintext), 5)) + "\n" if sub.plaintext.replace('.', '', 1).isdigit() else sub.plaintext + "\n"

		if text == '':
			for admin in ['752284535']:
				await bot.send_text(
					chat_id=admin,
					text="–ù–µ —Å–º–æ–≥ —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä:\n" + event.text
				)				
			return False
		return text	
	else:
		return False	


async def rand_answer(bot, event):
	if event.data['chat']['type'] == 'private':
		await sleep_send(bot, event)
		await bot.send_text(
				chat_id=event.from_chat,
				text=choice(space_answer.select())[1]
			)


async def ask(bot, event):
	await sleep_send(bot, event)
	await bot.send_text(
		chat_id=event.from_chat,
		text="–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? –°–µ–π—á–∞—Å —è –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π, –Ω–æ —è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É—á—É—Å—å:)",
		inline_keyboard_markup="{}".format(json.dumps([
			[{"text": "–î–∞", "callbackData": "call_back_id_1"}],
			[{"text": "–ù–µ—Ç", "callbackData": "call_back_id_2"}]
		])))


async def sticker(bot, event):
	if event.data['from']['userId'] in ['752284535']:
		#–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–æ–≤!
		space_sticker.insert((None, event.text.split('/')[-1]))
		await bot.send_text(
				chat_id=event.from_chat,
				text='–î–æ–±–∞–≤–∏–ª —Å—Ç–∏–∫–µ—Ä!'
			)		
	elif event.data['chat']['type'] == 'private':
		await sleep_send(bot, event)
		await bot.send_text(
				chat_id=event.from_chat,
				text='https://files.icq.net/get/' + choice(space_sticker.select())[1]
			)


async def media(bot, event):
	if event.data['chat']['type'] == 'private':
		await sleep_send(bot, event)
		await bot.send_text(
			chat_id=event.from_chat,
			text="–û–π, –æ–π. –ê –º–æ–∂–Ω–æ –≤—Å–µ —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ —Ç–µ–∫—Å—Ç–æ–º?"
			)	


async def button_1(bot, event):
	await bot.answer_callback_query(query_id=event.data['queryId'])
	await bot.send_actions(chat_id=event.data['message']['chat']['chatId'], actions='typing')
	await asyncio.sleep(2)
	user = User(user_id=event.data['from']['userId']).get()
	user.space[1] = True
	user.save()
	await bot.send_text(
		chat_id=event.data['message']['chat']['chatId'],
		text="–ü—Ä–∏—Å—ã–ª–∞–π –ø—Ä–∏–º–µ—Ä - —è —Ä–µ—à—É üòâ"
		)  


async def button_2(bot, event):
	await bot.answer_callback_query(query_id=event.data['queryId'])
	await bot.send_actions(chat_id=event.data['message']['chat']['chatId'], actions='typing')
	await asyncio.sleep(2)
	await bot.send_text(
		chat_id=event.data['message']['chat']['chatId'],
		text="–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
		)  


async def button_3(bot, event):
	await bot.answer_callback_query(query_id=event.data['queryId'])
	await bot.send_actions(chat_id=event.data['message']['chat']['chatId'], actions='typing')
	await asyncio.sleep(2)
	user = User(user_id=event.data['from']['userId']).get()
	if user.old_mes['text']:
		user.old_mes['text'] = user.old_mes['text'].replace('‚Äì', '-')	
		args = user.old_mes['text'].split(' ')
		# –∏—â–µ–º —Å–ª–æ–≤–æ –∫–æ–Ω—Å–ø–µ–∫—Ç, –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ —á—Ç–æ –æ–Ω–æ —Å—Ç–æ–∏—Ç –≤ –∫–æ–Ω—Ü–µ
		index_text = args.index(args[1]) + 1 if args.index(args[1]) else 0	
		name = new_foto(args[index_text:], fon=True)
		text = '–ì–æ—Ç–æ–≤–æ. –° —Ç–µ–±—è —à–æ–∫–æ–ª–∞–¥–∫–∞/–õ–æ–≤–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç/–ü–æ–ª—É—á–∏—Ç–µ, —Ä–∞—Å–ø–∏—à–∏—Ç–µ—Å—å/–í—É–∞–ª—è/–ò –Ω–µ –æ—Ç–ª–∏—á–∏—à—å, –¥–∞?'
		with open(name, 'rb') as file:
			await bot.send_file(
				chat_id=event.data['message']['chat']['chatId'],
				file=file, 
				caption=choice(text.split('/'))
				)
		user.old_mes['text'] = None
		os.remove(name)		
	else:
		await bot.send_text(
			chat_id=event.data['message']['chat']['chatId'],
			text='–ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç —Ä—É–∫–∏ - —è –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —Å–∫–∞–Ω'
		)	
		user.old_mes['text'] = '–ù–∞–ø–∏—à–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç'
	user.save()


async def button_4(bot, event):
	await bot.answer_callback_query(query_id=event.data['queryId'])
	await bot.send_actions(chat_id=event.data['message']['chat']['chatId'], actions='typing')
	await asyncio.sleep(2)
	user = User(user_id=event.data['from']['userId']).get()
	if user.old_mes['text']:
		user.old_mes['text'] = user.old_mes['text'].replace('‚Äì', '-')	
		args = user.old_mes['text'].split(' ')
		# –∏—â–µ–º —Å–ª–æ–≤–æ –∫–æ–Ω—Å–ø–µ–∫—Ç, –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ —á—Ç–æ –æ–Ω–æ —Å—Ç–æ–∏—Ç –≤ –∫–æ–Ω—Ü–µ
		index_text = args.index(args[1]) + 1 if args.index(args[1]) else 0		
		name = new_foto(args[index_text:], fon=False)
		text = '–ì–æ—Ç–æ–≤–æ. –° —Ç–µ–±—è —à–æ–∫–æ–ª–∞–¥–∫–∞/–õ–æ–≤–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç/–ü–æ–ª—É—á–∏—Ç–µ, —Ä–∞—Å–ø–∏—à–∏—Ç–µ—Å—å/–í—É–∞–ª—è/–ò –Ω–µ –æ—Ç–ª–∏—á–∏—à—å, –¥–∞?'
		with open(name, 'rb') as file:
			await bot.send_file(
				chat_id=event.data['message']['chat']['chatId'],
				file=file, 
				caption=choice(text.split('/'))
				)
		user.old_mes['text'] = None
		os.remove(name)	
	else:
		await bot.send_text(
			chat_id=event.data['message']['chat']['chatId'],
			text='–ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç —Ä—É–∫–∏ - —è –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —Å–∫–∞–Ω'
		)	
		user.old_mes['text'] = '–ù–∞–ø–∏—à–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç'
	user.save()


async def add_phrases(bot, event):
	if event.data['from']['userId'] in ['752284535']:
		await sleep_send(bot, event)
		for c in event.text[12:].split('\n'):
			space_phrases.insert((None, c))		
		await bot.send_text(
			chat_id=event.from_chat,
			text="–î–æ–±–∞–≤–∏–ª –Ω–æ–≤—É—é —Ñ—Ä–∞–∑—É - " + '\n'.join(event.text[12:].split('\n'))
		) 


async def add_answer(bot, event):
	if event.data['from']['userId'] in ['752284535']:
		await sleep_send(bot, event)
		for c in event.text[11:].split('\n'):
			space_answer.insert((None, c))
		await bot.send_text(
			chat_id=event.from_chat, 
			text="–î–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç—ã - " + '\n'.join(event.text[11:].split('\n'))
		)


def scale_image(input_image_path, width=None, height=None):
	original_image = Image.open(input_image_path)
	w, h = original_image.size

	if width and height:
		max_size = (width, height)
	elif width:
		max_size = (width, h)
	elif height:
		max_size = (w, height)
	else:
		raise RuntimeError('Width or height required!')
 
	original_image.thumbnail(max_size, Image.ANTIALIAS)
	return original_image


def separation_text(args, count):
	len_str = 0
	text_list = ['']
	for index, c in enumerate(args):
		if len(text_list[-1].split('\n')) >= 2:
			split = text_list[-1].split('\n')
			text_list[-1] = split[0]
			len_str = len(split[1]) + 8
			text_list.append("‚Äî" + split[1])
		else:
			len_str += len(c) + 1
		if len_str < count:
			text_list[-1] +=  f" {c}"
		else:
			len_str = len(c) + 1
			text_list.append(c)

	return [c.strip() for c in text_list]


def new_foto(args, fon=True):
	configs_path = os.path.realpath(os.path.dirname(sys.argv[0])) + "/"
	if fon:
		base = scale_image(configs_path + 'fon/' + str(randint(1, 4)) + '.jpg', height=450).convert('RGBA')
	fnt = ImageFont.truetype(configs_path + 'Brush font one.otf', size=16)
	text = separation_text(args, 50)
	text[0] = "‚Äî" + text[0]
	if len(text) >= 23:
		if fon:
			tetrad = Image.open(configs_path + 'notebook/2.png').convert('RGBA')
			draw = ImageDraw.Draw(tetrad)
			draw.multiline_text((60, 11), '\n'.join(text[:17]), font=fnt, fill=(5, 4, 170, 165), spacing=8)
			draw.multiline_text((335, 12),  '\n'.join(text[17:34]), font=fnt, fill=(5, 4, 170, 165), spacing=8)	
		else:
			tetrad = Image.open(configs_path + 'notebook/4.png').convert('RGBA')
			draw = ImageDraw.Draw(tetrad)
			draw.multiline_text((53, 3), '\n'.join(text[:17]), font=fnt, fill=(5, 4, 170, 165), spacing=8)
			draw.multiline_text((335, 12),  '\n'.join(text[17:34]), font=fnt, fill=(5, 4, 170, 165), spacing=8)	

		rand = randint(1, 3)
		if rand == 1:
			sh21 = scale_image(configs_path + 'foto/21.png', height=265)
			tetrad.paste(sh21, (600, 100),  sh21)
		elif rand == 2:
			sh22 = scale_image(configs_path + 'foto/22.png', height=265)
			tetrad.paste(sh22, (620, 100),  sh22)

		x_base_paste = 70
		y_base_paste = 25
	else:
		fnt = ImageFont.truetype(configs_path + 'Brush font one.otf', size = 29)
		if fon:
			tetrad = Image.open(configs_path + 'notebook/1.png').convert('RGBA')
			draw = ImageDraw.Draw(tetrad)
			draw.multiline_text((33, 61), '\n'.join(text), font=fnt, fill=(5, 4, 170, 165), spacing=8)
		else:
			tetrad = Image.open(configs_path + 'notebook/3.png').convert('RGBA')
			draw = ImageDraw.Draw(tetrad)
			draw.multiline_text((33, 3), '\n'.join(text), font=fnt, fill=(5, 4, 170, 165), spacing=8)
		rand = randint(1, 3)
		if rand == 1:
			sh21 = scale_image(configs_path + 'foto/21.png', height=465)
			tetrad.paste(sh21, (550, 150),  sh21)
		elif rand == 2:
			sh22 = scale_image( configs_path + 'foto/22.png', height=565)
			tetrad.paste(sh22, (570, 100),  sh22)	
		x_base_paste = 0
		y_base_paste = 0
		if fon:
			base = base.resize((500,520))
			tetrad.thumbnail((402,664), Image.ANTIALIAS)

	sh1 = scale_image(configs_path + 'foto/sh1.png', height=200)
	sh2 = scale_image(configs_path + 'foto/sh2.png', height=150)

	i = 0
	while i <= randint(0, 2):
		tetrad.paste(sh1, (randint(0, tetrad.size[0]), randint(0, tetrad.size[1])),  sh1)
		i += 1

	i = 0
	while i <= randint(0, 5):
		sh3 = scale_image(configs_path + 'foto/' + str(randint(1, 5)) + '.png', height=10).convert('RGBA')
		tetrad.paste(sh3, (randint(0, tetrad.size[0] - 50), randint(0, tetrad.size[1] - 20)),  sh3)
		i += 1

	random_name = configs_path + 'img/' + str(randint(0, 9999999)) + '_sfoto.png'
	if fon:
		base.paste(tetrad, (x_base_paste, y_base_paste),  tetrad)
		base.save(random_name)
	else:
		tetrad.save(random_name)
	return random_name


async def write_text(bot, event):
	await sleep_send(bot, event)
	user = User(user_id=event.data['from']['userId']).get()
	start_time = time.time()
	if user.old_mes['text'] is None:
		user.old_mes['text'] = event.data['text'].replace('—ë', '–µ')
	else:
		user.old_mes['text'] += " " + event.data['text'].replace('—ë', '–µ')
	text = user.old_mes['text']
	args = text.lower().split()

	# –∏—â–µ–º 2 —Å–ª–æ–≤–æ, –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ —á—Ç–æ –æ–Ω–æ —Å—Ç–æ–∏—Ç –≤ –∫–æ–Ω—Ü–µ
	index_text = args.index(args[1]) + 1 if args.index(args[1]) else 0
	if index_text == len(args):
		await bot.send_text(
			chat_id=event.from_chat,
			text='–ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç —Ä—É–∫–∏ - —è –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —Å–∫–∞–Ω'
		)
	elif index_text <= len(args):
		await bot.send_text(
			chat_id=event.from_chat,
			text="–ù—É–∂–µ–Ω —Ñ–æ–Ω —Å—Ç–æ–ª–∞?",
			inline_keyboard_markup="{}".format(json.dumps([
				[{"text": "–î–∞", "callbackData": "call_back_id_3"}],
				[{"text": "–ù–µ—Ç", "callbackData": "call_back_id_4"}]
			]))
		)
	user.save()
	